<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annotate Protein: {% if protein %}{{ protein.protein_id }}{% else %}Not Found{% endif %}</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            font-family: sans-serif;
            background-color: #fdfdfd;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            width: 100%;
            height: 500px;
            position: relative;
            border-radius: 10px;
            background: white;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease-out;
            will-change: transform;
            touch-action: none;
        }

        #pdbViewer {
            width: 100%;
            height: 100%;
            border-radius: 10px;
            overflow: hidden;
        }

        .info-message, .error-message {
            padding: 10px;
            margin-top: 10px;
        }

        .error-message {
            color: red;
            border: 1px solid red;
            font-weight: bold;
        }

        .info-message {
            color: blue;
        }

        .swipe-instruction {
            font-size: 0.9em;
            color: #777;
            margin-bottom: 10px;
        }

        .undo-button {
            margin-top: 10px;
            padding: 8px 12px;
            font-size: 0.9em;
            cursor: pointer;
        }

        footer {
            margin-top: 40px;
            text-align: center;
            font-size: 0.9em;
            color: #777;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.1.0/3Dmol-min.js" referrerpolicy="no-referrer"></script>
</head>
<body>
<div class="container">
    <h1>Protein Annotation Tool</h1>

    <div>
        {% if user.is_authenticated %}
            <span>Welcome, {{ user.username }}!</span> |
            <a href="{% url 'logout' %}?next={{ request.path }}">Logout</a>
        {% else %}
            <a href="{% url 'login' %}?next={{ request.path }}">Login</a> |
            <a href="{% url 'signup' %}">Sign Up</a>
        {% endif %}
    </div>
    <hr>
    <h3>{{ annotation_title }}</h3>
    <p>{{ annotation_description }}</p>

    {% if protein %}
        <h2>Annotate: {{ protein.protein_id }}</h2>
        {% if protein.name %}
            <p><strong>Name:</strong> {{ protein.name }}</p>
        {% endif %}

        <p>
            <small>File: {{ protein.pdb_file_path }}</small><br>
            <small>Viewer URL: {{ media_url }}{{ protein.pdb_file_path }}</small>
        </p>

        <div class="swipe-instruction">
            üëâ Swipe right = ‚úÖ correct &nbsp;&nbsp;|&nbsp;&nbsp; üëà left = ‚ùå wrong &nbsp;&nbsp;|&nbsp;&nbsp; üîª down = ‚ùì unsure
        </div>

        <div class="card" id="swipeCard">
            <div id="pdbViewer">
                <p class="info-message">Initializing 3D Viewer...</p>
            </div>
        </div>

        <button class="undo-button" id="undoBtn">‚Ü©Ô∏è Undo Last Annotation</button>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const viewerElement = document.getElementById("pdbViewer");
                const swipeCard = document.getElementById("swipeCard");
                const undoButton = document.getElementById("undoBtn");

                if (!viewerElement || typeof $3Dmol === 'undefined') {
                    viewerElement.innerHTML = "<p class='error-message'>Viewer or 3Dmol.js failed to load.</p>";
                    return;
                }

                const proteinId = "{{ protein.protein_id|escapejs }}";
                const folderId = "{{ protein.folder.id|escapejs }}";
                const pdbFilename = "{{ protein.pdb_file_path|escapejs }}";
                const mediaUrl = "{{ media_url|escapejs }}";
                const fileUrl = mediaUrl + pdbFilename;

                const viewer = $3Dmol.createViewer(viewerElement, {
                    defaultcolors: $3Dmol.elementColors.rasmol,
                    backgroundColor: 'white',
                });

                function animateRotation() {
                    viewer.rotate(1);
                    viewer.render();
                    requestAnimationFrame(animateRotation);
                }

                const fileFormat = (() => {
                    let ext = pdbFilename.split('.').pop().toLowerCase();
                    if (ext === 'ent') return 'pdb';
                    if (ext === 'mmcif') return 'cif';
                    return ['pdb', 'cif', 'mol2', 'sdf'].includes(ext) ? ext : 'pdb';
                })();

                $3Dmol.download(fileUrl, viewer, { format: fileFormat })
                    .then(() => {
                        viewer.setStyle({}, { cartoon: { color: 'spectrum' } });
                        viewer.zoomTo();
                        viewer.render();
                        animateRotation();
                    })
                    .catch(error => {
                        viewerElement.innerHTML = `<p class='error-message'>Error loading structure:<br>${error}</p>`;
                    });

                function getSwipeDirection(dx, dy) {
                    const minDistance = 150;
                    if (Math.abs(dx) > Math.abs(dy)) {
                        if (dx > minDistance) return 'right';
                        if (dx < -minDistance) return 'left';
                    } else {
                        if (dy > minDistance) return 'down';
                    }
                    return null;
                }

                function submitAnnotation(direction) {
                    const emoji = direction === 'right' ? '‚úÖ' : direction === 'left' ? '‚ùå' : '‚ùì';
                    viewerElement.innerHTML = `<p class='info-message'>${emoji} Annotated as ${direction.toUpperCase()}</p>`;

                    fetch("{% url 'annotations_app:annotate' %}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}"
                        },
                        body: JSON.stringify({
                            protein_id: proteinId,
                            folder_id: folderId,
                            annotation: direction
                        })
                    }).then(() => {
                        setTimeout(() => window.location.reload(), 500);
                    });
                }

                undoButton.addEventListener("click", () => {
                    fetch("{% url 'annotations_app:undo' %}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}"
                        }
                    }).then(response => response.json())
                      .then(data => {
                          if (data.success) {
                              location.reload();
                          } else {
                              alert("Undo failed: " + data.error);
                          }
                      });
                });

                // Drag / Swipe Logic
                let startX, startY, currentX, currentY, isDragging = false;

                function setCardTransform(dx, dy) {
                    const rotate = dx * 0.05;
                    swipeCard.style.transform = `translate(${dx}px, ${dy}px) rotate(${rotate}deg)`;
                }

                function resetCardPosition() {
                    swipeCard.style.transition = "transform 0.3s ease-out";
                    swipeCard.style.transform = `translate(0, 0) rotate(0deg)`;
                    setTimeout(() => swipeCard.style.transition = "", 300);
                }

                function handleSwipeEnd(dx, dy) {
                    const direction = getSwipeDirection(dx, dy);
                    const absDx = Math.abs(dx);
                    const absDy = Math.abs(dy);
                    const threshold = 150;

                    if ((absDx > threshold || absDy > threshold) && direction) {
                        const offX = dx > 0 ? window.innerWidth : -window.innerWidth;
                        const offY = dy > 0 ? window.innerHeight : -window.innerHeight;
                        swipeCard.style.transition = "transform 0.5s ease-out";
                        swipeCard.style.transform = `translate(${offX}px, ${offY}px) rotate(${dx * 0.1}deg)`;
                        setTimeout(() => submitAnnotation(direction), 300);
                    } else {
                        resetCardPosition();
                    }
                }

                // Mouse
                swipeCard.addEventListener('mousedown', e => {
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                });

                document.addEventListener('mousemove', e => {
                    if (!isDragging) return;
                    currentX = e.clientX;
                    currentY = e.clientY;
                    const dx = currentX - startX;
                    const dy = currentY - startY;
                    setCardTransform(dx, dy);
                });

                document.addEventListener('mouseup', e => {
                    if (!isDragging) return;
                    isDragging = false;
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    handleSwipeEnd(dx, dy);
                });

                // Touch
                swipeCard.addEventListener('touchstart', e => {
                    isDragging = true;
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                });

                swipeCard.addEventListener('touchmove', e => {
                    if (!isDragging) return;
                    currentX = e.touches[0].clientX;
                    currentY = e.touches[0].clientY;
                    const dx = currentX - startX;
                    const dy = currentY - startY;
                    setCardTransform(dx, dy);
                });

                swipeCard.addEventListener('touchend', e => {
                    if (!isDragging) return;
                    isDragging = false;
                    const dx = e.changedTouches[0].clientX - startX;
                    const dy = e.changedTouches[0].clientY - startY;
                    handleSwipeEnd(dx, dy);
                });
            });
        </script>
    {% elif message %}
        <p class="info-message">{{ message }}</p>
    {% else %}
        <p>No protein available for annotation or protein could not be loaded.</p>
    {% endif %}

    <hr>
    <footer>
        <p><small>Annotation Tool &copy; 2025</small></p>
    </footer>
</div>
</body>
</html>
