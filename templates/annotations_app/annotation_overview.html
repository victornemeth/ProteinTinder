<!-- templates/annotations_app/annotation_overview.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Annotation Overview: {{ folder.name }}</title>
    <style>
        /* Basic styling */
        body { font-family: sans-serif; padding: 20px; background-color: #f8f9fa; }
        .container { max-width: 900px; margin: auto; background-color: #fff; padding: 20px 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h2 { border-bottom: 1px solid #dee2e6; padding-bottom: 10px; }
        h3 { margin-top: 30px; color: #495057; }
        ul { list-style: none; padding: 0; }
        li {
            border-bottom: 1px solid #eee;
            padding: 20px 0; /* Increased vertical padding (was 10px) */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        li:last-child { border-bottom: none; }
        .protein-info { display: flex; align-items: center; }
        .thumbnail {
            width: 90px; /* Increased size (was 60px) */
            height: 90px;/* Increased size (was 60px) */
            margin-right: 20px; /* Slightly increased margin */
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            font-size: 0.8em; /* Slightly larger loading text */
            text-align: center;
            overflow: hidden;
            border-radius: 4px;
            position: relative;
            flex-shrink: 0;
        }
        /* Adjust font size of protein ID if desired */
        .protein-info span {
             font-size: 1.1em; /* Optional: make text slightly larger */
        }
        .action-link {
            margin-left: 15px;
            font-size: 0.95em; /* Slightly larger button text */
            color: #007bff;
            text-decoration: none;
            background-color: #e7f3ff;
            padding: 8px 12px; /* Increased button padding */
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        .action-link:hover { text-decoration: none; background-color: #cce5ff; }
        .back-link { margin-bottom: 20px; display: inline-block; color: #6c757d; text-decoration: none; }
        .back-link:hover { text-decoration: underline; }
        .empty-list-message { color: #6c757d; font-style: italic; padding: 20px 0; /* Match li padding */ }
    </style>
    <!-- Include 3Dmol.js if you want to show thumbnails -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.1.0/3Dmol-min.js" referrerpolicy="no-referrer"></script>
</head>
<body>
    <div class="container">
        <a href="{% url 'annotations_app:view_folders' %}" class="back-link">‚Üê Back to Folder List</a>
        <h2>Annotation Overview for: {{ folder.name }}</h2>
        <p><strong>Title:</strong> {{ folder.title }}</p>
        <p><strong>Description:</strong> {{ folder.description }}</p>

        {% for annotation_type, proteins in grouped_annotations.items %}
            <h3>{{ annotation_type|capfirst }} ({{ proteins|length }})</h3>
            <ul>
                {% for protein in proteins %}
                <li>
                    <span class="protein-info">
                        <!-- Optional Thumbnail Placeholder -->
                        <div id="viewer-{{ protein.id }}" class="thumbnail">Loading...</div>
                        <span>{{ protein.protein_id }}</span>
                    </span>
                    <span>
                        <!-- Link to re-annotate this specific protein -->
                        <a href="{% url 'annotations_app:annotate_specific_protein' folder_id=folder.id protein_pk=protein.pk %}" class="action-link">Re-annotate</a>
                    </span>
                </li>
                {% empty %}
                <li class="empty-list-message">No proteins annotated as {{ annotation_type }}.</li>
                {% endfor %}
            </ul>
        {% endfor %}

        {% if not grouped_annotations %}
            <p class="empty-list-message">You haven't annotated any proteins in this folder yet.</p>
            <a href="{% url 'annotations_app:annotate_protein' folder_id=folder.id %}" class="action-link">Start Annotating</a>
        {% endif %}
    </div>

    <script>
        // Optional: Tiny 3Dmol viewers for thumbnails
        document.addEventListener("DOMContentLoaded", function() {
            const viewers = {};
            {% for annotation_type, proteins in grouped_annotations.items %}
                {% for protein in proteins %}
                    const viewerElement_{{ protein.id }} = document.getElementById('viewer-{{ protein.id }}');
                    if (viewerElement_{{ protein.id }} && "{{ protein.pdb_file_path|escapejs }}") { // Check element and path exist
                        try {
                            // --- CORRECTED USAGE ---
                            const pdbPath_{{ protein.id }} = "{{ media_url }}{{ protein.pdb_file_path|escapejs }}";
                            const filename_{{ protein.id }} = "{{ protein.pdb_file_path|escapejs }}".split('/').pop(); // Get filename
                            const format_{{ protein.id }} = filename_{{ protein.id }}.split('.').pop().toLowerCase();
                            // Determine format, default to pdb if unsure
                            const finalFormat_{{ protein.id }} = ['pdb', 'cif', 'sdf', 'mol2'].includes(format_{{ protein.id }}) ? format_{{ protein.id }} : 'pdb';

                            // Create the viewer instance
                            viewers[{{ protein.id }}] = $3Dmol.createViewer(viewerElement_{{ protein.id }}, { backgroundColor: 'lightgrey' });

                            // Use $3Dmol.download which returns a Promise
                            $3Dmol.download(pdbPath_{{ protein.id }}, viewers[{{ protein.id }}], { format: finalFormat_{{ protein.id }} })
                                .then(function(){
                                    // Success: Style and render the model
                                    // Stick representation might be clearer for small thumbnails
                                    // viewers[{{ protein.id }}].setStyle({}, { stick: {} });
                                    // Or keep cartoon:
                                    viewers[{{ protein.id }}].setStyle({}, { cartoon: { color: 'spectrum' } });
                                    viewers[{{ protein.id }}].zoomTo();
                                    viewers[{{ protein.id }}].render();
                                    viewers[{{ protein.id }}].zoom(1.5); // Zoom in a bit more for thumbnails
                                    viewers[{{ protein.id }}].render(); // Re-render after zoom
                                })
                                .catch(function(err){
                                    // Handle download errors
                                    viewerElement_{{ protein.id }}.innerHTML = 'Load Err'; // Short error message
                                    console.error("Error loading PDB for thumbnail {{ protein.id }} using $3Dmol.download:", err);
                                });
                            // --- END CORRECTION ---

                        } catch (e) {
                            // Handle viewer creation errors
                            viewerElement_{{ protein.id }}.innerHTML = 'View Err';
                            console.error("Error creating viewer for {{ protein.id }}:", e);
                        }
                    } else if (viewerElement_{{ protein.id }}) {
                         viewerElement_{{ protein.id }}.innerHTML = 'No Path'; // Indicate if path is missing
                    }
                {% endfor %}
            {% endfor %}
        });
    </script>

</body>
</html>
