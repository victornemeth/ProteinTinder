<!-- templates/annotations_app/annotation_overview.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Annotation Overview: {{ folder.name }}</title>
    <style>
        /* Basic styling */
        body { font-family: sans-serif; padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        h2, h3 { margin-top: 30px; }
        ul { list-style: none; padding: 0; }
        li { border-bottom: 1px solid #eee; padding: 8px 0; display: flex; justify-content: space-between; align-items: center; }
        .protein-info { display: flex; align-items: center; }
        .thumbnail { width: 50px; height: 50px; margin-right: 15px; background-color: #f0f0f0; border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; font-size: 0.7em; text-align: center; overflow: hidden; }
        .action-link { margin-left: 15px; font-size: 0.9em; color: #007acc; text-decoration: none; }
        .action-link:hover { text-decoration: underline; }
        .back-link { margin-bottom: 20px; display: inline-block; }
    </style>
    <!-- Include 3Dmol.js if you want to show thumbnails -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.1.0/3Dmol-min.js" referrerpolicy="no-referrer"></script>
</head>
<body>
    <div class="container">
        <a href="{% url 'annotations_app:view_folders' %}" class="back-link">‚Üê Back to Folder List</a>
        <h2>Annotation Overview for: {{ folder.name }}</h2>
        <p><strong>Title:</strong> {{ folder.title }}</p>
        <p><strong>Description:</strong> {{ folder.description }}</p>

        {% for annotation_type, proteins in grouped_annotations.items %}
            <h3>{{ annotation_type|capfirst }} ({{ proteins|length }})</h3>
            <ul>
                {% for protein in proteins %}
                <li>
                    <span class="protein-info">
                        <!-- Optional Thumbnail Placeholder -->
                        <div id="viewer-{{ protein.id }}" class="thumbnail">Loading...</div>
                        <span>{{ protein.protein_id }} {% if protein.name %}({{ protein.name }}){% endif %}</span>
                    </span>
                    <span>
                        <!-- Link to re-annotate this specific protein -->
                        <a href="{% url 'annotations_app:annotate_specific_protein' folder_id=folder.id protein_pk=protein.pk %}" class="action-link">Re-annotate</a>
                    </span>
                </li>
                {% empty %}
                <li>No proteins annotated as {{ annotation_type }}.</li>
                {% endfor %}
            </ul>
        {% endfor %}

        {% if not grouped_annotations %}
            <p>You haven't annotated any proteins in this folder yet.</p>
            <a href="{% url 'annotations_app:annotate_protein' folder_id=folder.id %}" class="action-link">Start Annotating</a>
        {% endif %}
    </div>

    <script>
        // Optional: Tiny 3Dmol viewers for thumbnails
        document.addEventListener("DOMContentLoaded", function() {
            const viewers = {};
            {% for annotation_type, proteins in grouped_annotations.items %}
                {% for protein in proteins %}
                    const viewerElement_{{ protein.id }} = document.getElementById('viewer-{{ protein.id }}');
                    if (viewerElement_{{ protein.id }}) {
                        try {
                            const pdbPath_{{ protein.id }} = "{{ media_url }}{{ protein.pdb_file_path|escapejs }}";
                            viewers[{{ protein.id }}] = $3Dmol.createViewer(viewerElement_{{ protein.id }}, { backgroundColor: 'lightgrey' });
                            viewers[{{ protein.id }}].addModel(pdbPath_{{ protein.id }}, 'pdb')
                                .then(function(){
                                    viewers[{{ protein.id }}].setStyle({}, { cartoon: { color: 'spectrum' } });
                                    viewers[{{ protein.id }}].zoomTo();
                                    viewers[{{ protein.id }}].render();
                                    // viewers[{{ protein.id }}].zoom(1.2); // Adjust zoom if needed
                                })
                                .catch(function(err){
                                    viewerElement_{{ protein.id }}.innerHTML = 'Error';
                                    console.error("Error loading PDB for thumbnail {{ protein.id }}:", err);
                                });
                        } catch (e) {
                            viewerElement_{{ protein.id }}.innerHTML = 'No View';
                            console.error("Error creating viewer for {{ protein.id }}:", e);
                        }
                    }
                {% endfor %}
            {% endfor %}
        });
    </script>

</body>
</html>
